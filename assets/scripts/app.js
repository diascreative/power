(function (angular) {
  'use strict';

  var app = angular.module('windTurbineApp', ['ngBootstrap', 'angular-rickshaw']);

  app.controller('turbineController', ['$scope', function($scope) {
    $scope.rotationSpeed = 10;

    this.graph = {};
    this.currentPercentage = 0;
    $scope.prevSpeed = 0;
    this.speed = 0;
    //this.daterange = { "startDate": "2013-09-19T22:00:00.000Z", "endDate": "2013-09-24T22:00:00.000Z" };
    //this.daterange = moment().range('2012-11-05', '2013-01-25');

    var hoverGraph = function(y) {
      if( y < 15000 ) {
        // demand is never under 20,000 and wind is always under 4,000
        // this is a way to make sure the turbine doesn't rotate at
        // the demand rate
        var speed = y/500;

        if( speed !==  $scope.prevSpeed ) {
          $scope.prevSpeed = speed;
          animateWindMill(speed);
        }
      }
      return y + 'MW';
    },
    graphSetup = function(transport) {
      var wind_test = (graph.series[0].data.pop());
      var demand_test = (graph.series[1].data.pop());
      this.currentPercentage = (wind_test.y)/(demand_test.y) * 100;
    },
    animateWindMill = function(speed) {
      var $rContainer = $('#turbine-rotor-container');
      var $rotor = $('#turbine-rotor').eq(0);

      var valueS = (11 - speed),
        value = valueS + 's',
        degPerS = 360/(valueS*40),
        oldTransform = matrixToDeg($rotor.css('transform')),
        parentTransform = matrixToDeg($rContainer.css('transform'));

      $('#rotation-speed').val(value).change();

      $rContainer.css('transform', 'rotateZ(' + (oldTransform+parentTransform+degPerS) + 'deg)');
      $rotor.removeClass('animated');

      setTimeout(function() {
        $rotor.addClass('animated');
      }, 2);
    },
    matrixToDeg = function(tr) {
      var angle = 0;

      if( tr !== 'none' ) {
        var values = tr.split('(')[1];
        values = values.split(')')[0];
        values = values.split(',');

        var a = values[0],
          b = values[1],
          c = values[2],
          d = values[3],
          scale = Math.sqrt(a*a + b*b);

        var radians = Math.atan2(b, a);

        if ( radians < 0 ) {
          radians += (2 * Math.PI);
        }

        angle = Math.round( radians * (180/Math.PI));
      }

      return angle;
    };


    this.graph.options = {
      renderer: 'area',
      height: 100,
    };

    this.graph.features = {
      hover: {
        yFormatter: hoverGraph.bind(this)
      },
      complete: graphSetup.bind(this)
    };

    //this.graph.series = [{"name":"Wind","color":'#29abe2',"data":[{"x":1412862603,"y":3306},{"x":1412863203,"y":3264},{"x":1412866804,"y":3467},{"x":1412870402,"y":3429},{"x":1412874002,"y":3236},{"x":1412877602,"y":3184},{"x":1412881202,"y":3169},{"x":1412884802,"y":2826},{"x":1412888405,"y":2796},{"x":1412892004,"y":2948},{"x":1412895602,"y":2838},{"x":1412899201,"y":2966},{"x":1412902805,"y":2955},{"x":1412906405,"y":2551},{"x":1412910003,"y":2530},{"x":1412913605,"y":2334},{"x":1412917201,"y":1901},{"x":1412920804,"y":1547},{"x":1412924401,"y":1451},{"x":1412928003,"y":1337},{"x":1412931603,"y":1490},{"x":1412935202,"y":1588},{"x":1412938804,"y":1715},{"x":1412942415,"y":1748},{"x":1412946007,"y":2010},{"x":1412950202,"y":0},{"x":1412953215,"y":1610},{"x":1412956824,"y":1331},{"x":1412960411,"y":1729},{"x":1412964029,"y":1343},{"x":1412967632,"y":1181},{"x":1412971232,"y":1168},{"x":1412974827,"y":1131},{"x":1412978743,"y":803},{"x":1412982002,"y":761},{"x":1412985606,"y":533},{"x":1412989236,"y":446},{"x":1412992802,"y":709},{"x":1412996401,"y":0},{"x":1413000003,"y":0},{"x":1413003602,"y":0},{"x":1413007202,"y":621},{"x":1413010803,"y":602},{"x":1413014402,"y":630},{"x":1413018002,"y":504},{"x":1413021603,"y":273},{"x":1413025202,"y":264},{"x":1413028803,"y":344},{"x":1413032403,"y":473},{"x":1413036003,"y":546},{"x":1413039605,"y":666},{"x":1413043202,"y":479},{"x":1413046803,"y":622},{"x":1413050402,"y":857},{"x":1413054003,"y":887},{"x":1413057602,"y":851},{"x":1413061204,"y":827},{"x":1413064803,"y":728},{"x":1413068402,"y":714},{"x":1413072002,"y":533},{"x":1413075602,"y":421},{"x":1413079202,"y":368},{"x":1413082803,"y":323},{"x":1413086406,"y":284},{"x":1413090001,"y":261},{"x":1413093602,"y":285},{"x":1413097202,"y":246},{"x":1413100802,"y":239},{"x":1413104403,"y":237},{"x":1413108001,"y":280},{"x":1413111605,"y":242},{"x":1413115204,"y":231},{"x":1413118801,"y":326},{"x":1413122401,"y":495},{"x":1413126004,"y":677},{"x":1413129603,"y":1057},{"x":1413133203,"y":1362},{"x":1413136805,"y":1359},{"x":1413140403,"y":1748},{"x":1413144002,"y":1938},{"x":1413147602,"y":2018},{"x":1413151205,"y":2153},{"x":1413154804,"y":2229},{"x":1413158404,"y":2382},{"x":1413162002,"y":2576},{"x":1413165605,"y":2564},{"x":1413169205,"y":2667},{"x":1413172801,"y":2501},{"x":1413176401,"y":2550},{"x":1413180003,"y":2822},{"x":1413183603,"y":2811},{"x":1413187203,"y":3007},{"x":1413190802,"y":2966},{"x":1413194409,"y":2982},{"x":1413198003,"y":3195},{"x":1413201604,"y":3547},{"x":1413205201,"y":3556},{"x":1413208803,"y":3537},{"x":1413212404,"y":3613},{"x":1413216002,"y":3988},{"x":1413219602,"y":3874},{"x":1413223202,"y":3743},{"x":1413226801,"y":3735},{"x":1413230406,"y":3870},{"x":1413234003,"y":3646},{"x":1413237602,"y":3824},{"x":1413241203,"y":3590},{"x":1413244802,"y":3167},{"x":1413248406,"y":2850},{"x":1413252002,"y":2379},{"x":1413255602,"y":2303},{"x":1413259201,"y":2200},{"x":1413262802,"y":2197},{"x":1413266403,"y":2038},{"x":1413270004,"y":2019},{"x":1413273602,"y":2037},{"x":1413277205,"y":1918},{"x":1413280802,"y":1961},{"x":1413284406,"y":2006},{"x":1413288005,"y":1649},{"x":1413291604,"y":1569},{"x":1413295205,"y":1519},{"x":1413298804,"y":1572},{"x":1413302402,"y":1331},{"x":1413306003,"y":1187},{"x":1413309602,"y":1197},{"x":1413313205,"y":1747},{"x":1413316802,"y":1798},{"x":1413320404,"y":1651},{"x":1413324002,"y":1280},{"x":1413327602,"y":1409},{"x":1413331202,"y":1402},{"x":1413334802,"y":1243},{"x":1413338403,"y":1407},{"x":1413342003,"y":1332},{"x":1413345601,"y":1338},{"x":1413349202,"y":1533},{"x":1413352802,"y":1730},{"x":1413356402,"y":1767},{"x":1413360004,"y":1920},{"x":1413363602,"y":1916},{"x":1413367202,"y":2200},{"x":1413370802,"y":2406},{"x":1413374402,"y":2636},{"x":1413378002,"y":2931}]},{"name":"Demand","color":"#f15a24", "data":[{"x":1412862603,"y":37850},{"x":1412863203,"y":37897},{"x":1412866804,"y":38903},{"x":1412870402,"y":40614},{"x":1412874002,"y":41507},{"x":1412877602,"y":44297},{"x":1412881202,"y":42427},{"x":1412884802,"y":39719},{"x":1412888405,"y":35855},{"x":1412892004,"y":31075},{"x":1412895602,"y":27803},{"x":1412899201,"y":26442},{"x":1412902805,"y":27175},{"x":1412906405,"y":26484},{"x":1412910003,"y":26165},{"x":1412913605,"y":26526},{"x":1412917201,"y":27246},{"x":1412920804,"y":33956},{"x":1412924401,"y":39231},{"x":1412928003,"y":39167},{"x":1412931603,"y":39339},{"x":1412935202,"y":38437},{"x":1412938804,"y":37965},{"x":1412942415,"y":37693},{"x":1412946007,"y":36930},{"x":1412950202,"y":2695},{"x":1412953215,"y":36959},{"x":1412956824,"y":39359},{"x":1412960411,"y":39914},{"x":1412964029,"y":42910},{"x":1412967632,"y":40983},{"x":1412971232,"y":37939},{"x":1412974827,"y":34902},{"x":1412978743,"y":30712},{"x":1412982002,"y":27224},{"x":1412985606,"y":26662},{"x":1412989236,"y":26937},{"x":1412992802,"y":26027},{"x":1412996401,"y":2249},{"x":1413000003,"y":2249},{"x":1413003602,"y":2249},{"x":1413007202,"y":27566},{"x":1413010803,"y":31133},{"x":1413014402,"y":34562},{"x":1413018002,"y":35740},{"x":1413021603,"y":35714},{"x":1413025202,"y":35286},{"x":1413028803,"y":34617},{"x":1413032403,"y":33416},{"x":1413036003,"y":32564},{"x":1413039605,"y":32918},{"x":1413043202,"y":34765},{"x":1413046803,"y":36806},{"x":1413050402,"y":39780},{"x":1413054003,"y":37812},{"x":1413057602,"y":35462},{"x":1413061204,"y":32728},{"x":1413064803,"y":29930},{"x":1413068402,"y":26518},{"x":1413072002,"y":25104},{"x":1413075602,"y":25337},{"x":1413079202,"y":25185},{"x":1413082803,"y":24769},{"x":1413086406,"y":24488},{"x":1413090001,"y":24783},{"x":1413093602,"y":26660},{"x":1413097202,"y":27480},{"x":1413100802,"y":30669},{"x":1413104403,"y":33099},{"x":1413108001,"y":34126},{"x":1413111605,"y":34657},{"x":1413115204,"y":34484},{"x":1413118801,"y":33990},{"x":1413122401,"y":33790},{"x":1413126004,"y":34816},{"x":1413129603,"y":37136},{"x":1413133203,"y":38875},{"x":1413136805,"y":40309},{"x":1413140403,"y":38432},{"x":1413144002,"y":35892},{"x":1413147602,"y":32554},{"x":1413151205,"y":28813},{"x":1413154804,"y":25539},{"x":1413158404,"y":25000},{"x":1413162002,"y":25517},{"x":1413165605,"y":24601},{"x":1413169205,"y":24299},{"x":1413172801,"y":24525},{"x":1413176401,"y":26115},{"x":1413180003,"y":32205},{"x":1413183603,"y":38460},{"x":1413187203,"y":39320},{"x":1413190802,"y":40596},{"x":1413194409,"y":40853},{"x":1413198003,"y":40818},{"x":1413201604,"y":40738},{"x":1413205201,"y":40200},{"x":1413208803,"y":39919},{"x":1413212404,"y":40869},{"x":1413216002,"y":43059},{"x":1413219602,"y":44114},{"x":1413223202,"y":45245},{"x":1413226801,"y":42500},{"x":1413230406,"y":39091},{"x":1413234003,"y":35094},{"x":1413237602,"y":30527},{"x":1413241203,"y":27757},{"x":1413244802,"y":26066},{"x":1413248406,"y":27076},{"x":1413252002,"y":26445},{"x":1413255602,"y":25881},{"x":1413259201,"y":25862},{"x":1413262802,"y":27749},{"x":1413266403,"y":33947},{"x":1413270004,"y":39853},{"x":1413273602,"y":40243},{"x":1413277205,"y":41108},{"x":1413280802,"y":40982},{"x":1413284406,"y":41010},{"x":1413288005,"y":40941},{"x":1413291604,"y":40566},{"x":1413295205,"y":40380},{"x":1413298804,"y":41263},{"x":1413302402,"y":43222},{"x":1413306003,"y":44400},{"x":1413309602,"y":45834},{"x":1413313205,"y":43619},{"x":1413316802,"y":40705},{"x":1413320404,"y":36719},{"x":1413324002,"y":31975},{"x":1413327602,"y":29322},{"x":1413331202,"y":27591},{"x":1413334802,"y":28341},{"x":1413338403,"y":27370},{"x":1413342003,"y":27116},{"x":1413345601,"y":27121},{"x":1413349202,"y":29157},{"x":1413352802,"y":34729},{"x":1413356402,"y":39899},{"x":1413360004,"y":40114},{"x":1413363602,"y":40806},{"x":1413367202,"y":40807},{"x":1413370802,"y":40754},{"x":1413374402,"y":40346},{"x":1413378002,"y":39854}]}];
    this.graph.series = [{"name":"Wind","color":'#29abe2',"data":[{"x":1412862603,"y":3306},{"x":1412863203,"y":3264},{"x":1412866804,"y":3467},{"x":1412870402,"y":3429},{"x":1412874002,"y":3236},{"x":1412877602,"y":3184},{"x":1412881202,"y":3169},{"x":1412884802,"y":2826},{"x":1412888405,"y":2796},{"x":1412892004,"y":2948},{"x":1412895602,"y":2838},{"x":1412899201,"y":2966},{"x":1412902805,"y":2955},{"x":1412906405,"y":2551},{"x":1412910003,"y":2530},{"x":1412913605,"y":2334},{"x":1412917201,"y":1901},{"x":1412920804,"y":1547},{"x":1412924401,"y":1451},{"x":1412928003,"y":1337},{"x":1412931603,"y":1490},{"x":1412935202,"y":1588},{"x":1412938804,"y":1715},{"x":1412942415,"y":1748},{"x":1412946007,"y":2010},{"x":1412950202,"y":0},{"x":1412953215,"y":1610},{"x":1412956824,"y":1331},{"x":1412960411,"y":1729},{"x":1412964029,"y":1343},{"x":1412967632,"y":1181},{"x":1412971232,"y":1168},{"x":1412974827,"y":1131},{"x":1412978743,"y":803},{"x":1412982002,"y":761},{"x":1412985606,"y":533},{"x":1412989236,"y":446},{"x":1412992802,"y":709},{"x":1412996401,"y":0},{"x":1413000003,"y":0},{"x":1413003602,"y":0},{"x":1413007202,"y":621},{"x":1413010803,"y":602},{"x":1413014402,"y":630},{"x":1413018002,"y":504},{"x":1413021603,"y":273},{"x":1413025202,"y":264},{"x":1413028803,"y":344},{"x":1413032403,"y":473},{"x":1413036003,"y":546},{"x":1413039605,"y":666},{"x":1413043202,"y":479},{"x":1413046803,"y":622},{"x":1413050402,"y":857},{"x":1413054003,"y":887},{"x":1413057602,"y":851},{"x":1413061204,"y":827},{"x":1413064803,"y":728},{"x":1413068402,"y":714},{"x":1413072002,"y":533},{"x":1413075602,"y":421},{"x":1413079202,"y":368},{"x":1413082803,"y":323},{"x":1413086406,"y":284},{"x":1413090001,"y":261},{"x":1413093602,"y":285},{"x":1413097202,"y":246},{"x":1413100802,"y":239},{"x":1413104403,"y":237},{"x":1413108001,"y":280},{"x":1413111605,"y":242},{"x":1413115204,"y":231},{"x":1413118801,"y":326},{"x":1413122401,"y":495},{"x":1413126004,"y":677},{"x":1413129603,"y":1057},{"x":1413133203,"y":1362},{"x":1413136805,"y":1359},{"x":1413140403,"y":1748},{"x":1413144002,"y":1938},{"x":1413147602,"y":2018},{"x":1413151205,"y":2153},{"x":1413154804,"y":2229},{"x":1413158404,"y":2382},{"x":1413162002,"y":2576},{"x":1413165605,"y":2564},{"x":1413169205,"y":2667},{"x":1413172801,"y":2501},{"x":1413176401,"y":2550},{"x":1413180003,"y":2822},{"x":1413183603,"y":2811},{"x":1413187203,"y":3007},{"x":1413190802,"y":2966},{"x":1413194409,"y":2982},{"x":1413198003,"y":3195},{"x":1413201604,"y":3547},{"x":1413205201,"y":3556},{"x":1413208803,"y":3537},{"x":1413212404,"y":3613},{"x":1413216002,"y":3988},{"x":1413219602,"y":3874},{"x":1413223202,"y":3743},{"x":1413226801,"y":3735},{"x":1413230406,"y":3870},{"x":1413234003,"y":3646},{"x":1413237602,"y":3824},{"x":1413241203,"y":3590},{"x":1413244802,"y":3167},{"x":1413248406,"y":2850},{"x":1413252002,"y":2379},{"x":1413255602,"y":2303},{"x":1413259201,"y":2200},{"x":1413262802,"y":2197},{"x":1413266403,"y":2038},{"x":1413270004,"y":2019},{"x":1413273602,"y":2037},{"x":1413277205,"y":1918},{"x":1413280802,"y":1961},{"x":1413284406,"y":2006},{"x":1413288005,"y":1649},{"x":1413291604,"y":1569},{"x":1413295205,"y":1519},{"x":1413298804,"y":1572},{"x":1413302402,"y":1331},{"x":1413306003,"y":1187},{"x":1413309602,"y":1197},{"x":1413313205,"y":1747},{"x":1413316802,"y":1798},{"x":1413320404,"y":1651},{"x":1413324002,"y":1280},{"x":1413327602,"y":1409},{"x":1413331202,"y":1402},{"x":1413334802,"y":1243},{"x":1413338403,"y":1407},{"x":1413342003,"y":1332},{"x":1413345601,"y":1338},{"x":1413349202,"y":1533},{"x":1413352802,"y":1730},{"x":1413356402,"y":1767},{"x":1413360004,"y":1920},{"x":1413363602,"y":1916},{"x":1413367202,"y":2200},{"x":1413370802,"y":2406},{"x":1413374402,"y":2636},{"x":1413378002,"y":2931}]}];

  }]);

  app.directive('parseStyle', ['$interpolate', function($interpolate) {
    return function(scope, elem) {
      var exp = $interpolate(elem.html()),
        watchFunc = function () { return exp(scope); };

      scope.$watch(watchFunc, function (html) {
        elem.html(html);
      });
    };
  }]);

})(angular);